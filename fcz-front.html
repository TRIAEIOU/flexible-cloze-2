<!-- Title field at top of page -->
<div id="fcz-title" class="{{Tags}} title front">{{Title}}</div>

<!-- Main scrollable area of the screen -->
<div id="fcz-scroll-area" class="fcz-scroll-area front">

    <!-- Main content field, has to be present but can be styled/layouted differently -->
    <div id="fcz-content">{{cloze:Text}}</div>
    <div id="fcz-content-placeholder"></div>

    <!-- Additional fields, delete the divs to remove from the card -->
    <div id="fcz-additional">
        {{#Note}}
            <div id="note-header" class="additional-header">Note</div>
            <div id="note" class="additional-content">{{Note}}</div>
        {{/Note}}
        {{#Mnemonics}}
            <div id="mnemonics-header" class="additional-header">Mnemonics</div>
            <div id="mnemonics" class="additional-content">{{Mnemonics}}</div>
        {{/Mnemonics}}
        {{#Extra}}
            <div id="extra-header" class="additional-header">Extra</div>
            <div id="extra" class="additional-content">{{Extra}}</div>
        {{/Extra}}
        <div id="info-header" class="additional-header"> Information</div>
        <div id="info" class="additional-content">
            <div id="deck"><b>Deck</b>: {{Deck}}</div>
            {{#Tags}}<div id="tags"><b>Tags</b>: {{Tags}}</div>{{/Tags}}
        </div>
    </div>
    <!-- Optional "show all button" -->
    <div id="fcz-show-all-btn">Show all</div>
</div>

<!-- Footer at the bottom of the screen, delete to remove or modify/add to change -->
<div id="fcz-footer" class="front">
    <!-- Symbol legend, delete divs to remove or modify number and content of child divs -->
    <div id="fcz-legend-footer">
        <div class="fcz-legend-entry">&#8594; Becomes</div>
        <div class="fcz-legend-entry">&#8658; Leads to</div>
        <div class="fcz-legend-entry">&#10521; Excite/activate</div>
        <div class="fcz-legend-entry">&#10979; Inhibit/deactivate</div>
    </div>
    <!-- Flag legend, delete divs to remove, text and color can be set on "Styles" page -->
    <div id="fcz-flag-footer">
        <div id="fcz-flag-red" class="fcz-flag"></div>
        <div id="fcz-flag-orange" class="fcz-flag"></div>
        <div id="fcz-flag-green" class="fcz-flag"></div>
        <div id="fcz-flag-blue" class="fcz-flag"></div>
        <div id="fcz-flag-pink" class="fcz-flag"></div>
        <div id="fcz-flag-turquoise" class="fcz-flag"></div>
        <div id="fcz-flag-purple" class="fcz-flag"></div>
    </div>
</div>

<!-- Screen edge navigation controls, delete the divs to remove -->
<div id="nav-toggle-all" class="nav-area-top"></div>
<div id="nav-prev-cloze" class="nav-area-side"></div>
<div id="nav-next-cloze" class="nav-area-side"></div>

<!-- FCZ2 BEGIN [2.0] -->
<script type="application/javascript">

/* CONFIGURATION BEGIN ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ */
var config = {
    prompt: '',            // Prompt when no hint
    hint: '%h',               // %h is replaced with hint text
    expose: {
        chars: '!',             // Char(s) to mark exposed cloze
        pos: 'begin',           // Char pos: `pre`, `begin`, `end` or `post`
        reverse: false          // If true exposed clozes are hidden, others shown
    },
    scroll: {                   // Valid values: `none`, `min`, `center` or `context`
        initial: 'chapter-context',     // Scoll on initial show
        click: 'min',           // Scroll on cloze click
        iterate: 'min'          // Scroll on iteration
    },
    iteration: {
        top: false,             // Always start iteration from top
        loop: true,             // Restart from top/bottom from end
        hide: true              // Hide cloze iterated away from
    },
    shortcuts: {
        next: 'j',              // Iterate to next cloze
        previous: 'h',          // Iterate to previous cloze
        toggle_all: 'k'         // Toggle all clozes and fields
    },
    show: {                     // `false` means initially collapsed/hidden
        inactive: false,        // Inactive clozes
        additional: false,      // Additional fields (Note, Mnemonics etc.)
        info: false             // Information field
    }
}
/* CONFIGURATION END ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑ */

</script>
<!-- FUNCTIONALITY BEGIN -->
<script type="application/javascript">
if (typeof FCZ !== 'function') window.FCZ = class {
    content = null // parent of card HTML
    viewport = null // scroll area
    ordinal = 0 // current cloze ordinal
    exposed = null // function to determine if cloze is exposed
    init_done = false // flag to avoid adding multiple event listeners

    /////////////////////////////////////////////////////////////////
    // Generic init done on front and back
    init(config, specific) {
        this.cfg = config
        this.content = document.getElementById('fcz-content')
        this.viewport = document.getElementById('fcz-scroll-area')
        this.current = this.content.querySelector('.cloze')

        if (!this.ordinal)
            this.ordinal = parseInt(this.current.dataset.ordinal)
        this.exposed = this.generate_exposed()

        // Generic: set up inactive clozes
        this.content.querySelectorAll('.cloze-inactive').forEach(cloze => {
            if (this.exposed(cloze) || cloze.querySelector('.cloze'))
                cloze.classList.remove('cloze-inactive')
            else if (!this.cfg.show.inactive) this.hide(cloze)
        })

        // Generic: show additional fields per default depending on config
        if (this.cfg.show.additional)
            this.viewport.querySelectorAll(':not(#info).additional-content')
            .forEach(nd => { nd.style.display = 'block' })

        // Generic: show info field per default depending on config
        if (this.cfg.show.info)
            document.querySelector('div#info.additional-content')
            .style.display = 'block'

        // Generic: reveal finished content, hide placeholder and scroll to first active cloze
        this.content.style.display = 'block'
        document.getElementById('fcz-content-placeholder').style.display = 'none'

        // Setup event handlers if not already done
        if (!this.init_done) {
            this.init_done = true
            document.addEventListener("click", (evt) => {
                // Cloze click handling
                if (evt.target.classList.contains('cloze')
                    || evt.target.classList.contains('cloze-inactive')) {
                        evt.stopPropagation() // To avoid toggling parents
                        if (!fcz.cfg.iteration.top) fcz.current = evt.target
                        fcz.toggle_cloze(evt.target)
                        fcz.scroll_to(fcz.cfg.scroll.click, evt.target)
                // Additional content (header and actual content)
                } else if (evt.target.classList.contains('additional-header'))
                    fcz.toggle_field(evt.target.firstElementChild)
                else if (evt.target.classList.contains('additional-content'))
                    fcz.toggle_field(evt.target)
                // Toggle all button
                else if (evt.target.id === 'fcz-show-all-btn') fcz.toggle_all()
                // Nav bars
                else if (evt.target.id === 'nav-toggle-all') fcz.toggle_all()
                else if (evt.target.id === 'nav-prev-cloze') fcz.iter(false)
                else if (evt.target.id === 'nav-next-cloze') fcz.iter(true)
            })

            document.addEventListener("keydown", (evt) => {
                if (evt.key === fcz.cfg.shortcuts.next) {
                    fcz.iter(true)
                    evt.preventDefault()
                } else if (evt.key === fcz.cfg.shortcuts.previous) {
                    fcz.iter(false)
                    evt.preventDefault()
                } else if (evt.key === fcz.cfg.shortcuts.toggle_all) {
                    fcz.toggle_all()
                    evt.preventDefault()
                }
            })
        }

        if (specific) specific.call(this)
        this.scroll_to(this.cfg.scroll.initial)
    }

    /////////////////////////////////////////////////////////////////
    // Create exposed function from config
    generate_exposed() {
        let exposed_
        if (this.cfg.expose.pos === 'pre')
            exposed_ = (el) => {return el.previousSibling.wholeText?.endsWith(this.cfg.expose.chars)}
        else if (this.cfg.expose.pos === 'end')
            exposed_ = (el) => {return el.innerHTML.endsWith(this.cfg.expose.chars)}
        else if (this.cfg.expose.pos === 'post')
            exposed_ = (el) => {return el.nextSibling.wholeText?.startsWith(this.cfg.expose.chars)}
        else // this.cfg.expose.pos === 'begin'
            exposed_ = (el) => {return el.innerHTML.startsWith(this.cfg.expose.chars)}
        return this.cfg.expose.reverse ? (el) => {return !exposed_(el)} : exposed_
    }

    /////////////////////////////////////////////////////////////////
    // Hide cloze (and save cloze content as needed)
    hide(cloze) {
        if (!cloze || cloze.classList.contains('hide')) return
        if (cloze.dataset.cloze === undefined) cloze.dataset.cloze = cloze.innerHTML
        cloze.classList.add('hide')
        // Never knew the hint
        if (cloze.dataset.hint === undefined) cloze.dataset.hint = this.cfg.prompt
        cloze.innerHTML = cloze.dataset.hint
    }

    /////////////////////////////////////////////////////////////////
    // Show cloze (and save cloze hint as needed)
    show(cloze) {
        if (!cloze || !cloze.classList.contains('hide')) return
        if (cloze.dataset.hint === undefined) {
            if (cloze.innerHTML === '[...]' || cloze.classList.contains('cloze-inactive'))
                cloze.dataset.hint = this.cfg.prompt
            else
                cloze.dataset.hint = this.cfg.hint.replace('%h', cloze.innerHTML.substring(1, -1))
        }
        cloze.classList.remove('hide')
        cloze.innerHTML = cloze.dataset.cloze
        for (const child of cloze.querySelectorAll(':scope .cloze, :scope .cloze-inactive'))
            this.hide(child)
    }

    /////////////////////////////////////////////////////////////////
    // Toggle cloze visibility state
    toggle_cloze(cloze) {
        cloze.classList.contains('hide') ? this.show(cloze) : this.hide(cloze)
    }

    /////////////////////////////////////////////////////////////////
    // Toggle field visibility state
    toggle_field(field) {
        field.classList.contains('hide')
            ? field.classList.remove('hide')
            : field.classList.add('hide')
    }

    /////////////////////////////////////////////////////////////////
    // Toggle all clozes and fields, sync towards show
    toggle_all() {
        if (this.content.querySelector('.cloze.hide, .cloze-inactive.hide'))
            this.content.querySelectorAll('.cloze.hide, .cloze-inactive.hide')
            .forEach(el => { this.show(el) })
        else
            this.content.querySelectorAll('.cloze:not(.hide), .cloze-inactive:not(.hide)')
            .forEach(el => { this.hide(el) })
    }

    /////////////////////////////////////////////////////////////////
    // Iterate forward or backward, start by showing current if hidden
    iter(fwd) {
        const els = this.content.querySelectorAll('.cloze');
        let nxt
        if (this.current.classList.contains('hide'))
            nxt = this.current
        if (fwd && this.current === els[els.length - 1])
            nxt = this.cfg.iteration.loop ? els[0] : this.current
        else if (!fwd && this.current === els[0])
            nxt = this.cfg.iteration.loop ? els[els.length - 1] : this.current
        for (let i = 0; !nxt && i < els.length; i++) {
            if (els[i] === this.current) nxt = els[i + (fwd ? 1 : -1)]
        }
        if (nxt !== this.current && this.cfg.iteration.hide)
            this.hide(this.current)
        this.show(this.current = nxt)
        this.scroll_to(this.cfg.scroll.iterate, this.current)
    }

    /////////////////////////////////////////////////////////////////
    // Scroll to active clozes or specific cloze
    scroll_to(scroll, cloze = null) {
        if (scroll === 'none') return
        let first, last
        if (cloze) first = last = cloze
        else {
            const active = this.content.querySelectorAll('.cloze')
            first = active[0]
            last = active[active.length - 1]
        }

        const top = first.getBoundingClientRect().top + this.viewport.scrollTop -  this.viewport.offsetTop
        const bottom = last.getBoundingClientRect().bottom + this.viewport.scrollTop - this.viewport.offsetTop
        const middle = (this.viewport.offsetHeight - (bottom - top)) / 2
        const center = top - middle
        let y = 0

        // Context scroll, either from preceeding or HR/HX
        if (scroll.slice(-7) === 'context') {
            const all = this.content.querySelectorAll('.cloze, .cloze-inactive')
            for (let i = 1; i < all.length; i++)
                if (all[i] === first) {
                    y = Math.min(first.getBoundingClientRect().bottom + this.viewport.scrollTop - this.viewport.offsetTop, center)
                    break
                }
            if (scroll === 'chapter-context') {
                let sep
                for (const nd of this.content.querySelectorAll('hr, h1, h2, h3, h4, h5, h6, .cloze')) {
                    if (nd.tagName === 'SPAN') break
                    sep = nd
                }
                if (sep) {
                    const border = sep.tagName === 'HR'
                        ? sep.getBoundingClientRect().bottom
                        : sep.getBoundingClientRect().top + 5
                    y = Math.min(y, border + this.viewport.scrollTop - this.viewport.offsetTop)
                } else if (this.content.querySelector('hr, h1, h2, h3, h4, h5, h6'))
                    y = this.viewport.scrollTop - this.viewport.offsetTop
                // else y is already set to prev.bottom or center
            }
        }
        else if (bottom - top >= this.viewport.offsetHeight)
            // All clozes will not fit - scroll to first at top regardless
            y = top - line_height.call(this, window.getComputedStyle(first.previousElementSibling ? first.previousElementSibling : first, ':before'))
        else if (scroll === 'center') y = center
        // scroll === 'min'
        else y = bottom - this.viewport.offsetHeight + line_height.call(this, window.getComputedStyle(last.nextElementSibling
                ? last.nextElementSibling
                : last,
            ':after'))
        this.viewport.scrollTo(0, y)

        function line_height(style) {
            let lh
            if (style.lineHeight.toLowerCase() === "normal") {
                var nd = document.createElement('span')
                nd.innerHTML = '&nbsp;'
                nd.style = style
                nd.style.border = '0px'
                nd.style.margin = '0px'
                nd.style.padding = '0px'
                this.content.appendChild(nd)
                lh = nd.offsetHeight
                this.content.removeChild(nd)
            }
            if (!lh) lh = parseInt(style.lineHeight) || 20
            return lh
        }
    }
}

var fcz
if(!fcz) fcz = new window.FCZ()
// Run initialization
fcz.init(config, function() {
    // Side specific: hide active clozes
    this.content.querySelectorAll('.cloze').forEach(cloze => {
        this.hide(cloze)
    })
})
</script>
<!-- FUNCTIONALITY END -->
<!-- FCZ2 END -->